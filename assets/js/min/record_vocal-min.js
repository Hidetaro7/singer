function getAudioContext(){var e=audioContext.createMediaElementSource(video);gain=audioContext.createGain();var a=audioContext.createChannelSplitter(2),o=audioContext.createChannelMerger(2);e.connect(a),gain.gain.value=1,gain.value=1,a.connect(gain,1),gain.connect(o,0,0),gain.connect(o,0,1),a.connect(o,0,0),a.connect(o,0,1),o.connect(audioContext.destination)}function changeVocalMute(){$("body").toggleClass("muted_vo"),!$("body").hasClass("muted_vo")&&gain?gain.gain.value=gain.value=1:gain.gain.value=gain.value=0}function rec_start(){recordFlg=!0,console.log("rec_start"),ui_rec_start.disabled=!0,recorder=new MediaRecorder(cameraStream);var e=!1;recorder.ondataavailable=function(e){chunks.push(e.data),"inactive"==recorder.state&&(blob=new Blob(chunks,{type:e.data.type}),confirm_playBackVideo.src=window.URL.createObjectURL(blob),ui_post_video.disabled=!1)},video.play(),video.onended=rec_stop,chunks=[],recorder.start(),$("body").addClass("recording"),recordTime=(new Date).getTime()}function rec_stop(){console.log("rec_stop");var e=(new Date).getTime();recordFlg&&e-recordTime>1e3&&(ui_rec_start.disabled=!1,recorder&&"inactive"!=recorder.state&&recorder.stop(),video.pause(),video.currentTime=0,$("body").removeClass("recording playing").addClass("playbacking"),recordFlg=!1)}function init(){audioContext=new AudioContext,navigator.getUserMedia({video:!0,audio:!0},cameraSuccess,cameraError),ui_vocal_mute.onclick=changeVocalMute,video.onplay=function(){$("body").addClass("playing")},video.onpause=function(){$("body").removeClass("playing")},ui_rec_stop.onclick=rec_stop,ui_rec_start.onclick=rec_start,ui_overlay_close.onclick=function(){blob=null,confirm_playBackVideo.src=null,$("body").removeClass("playbacking")},ui_post_video.onclick=postVideo,video.oncanplay=function(){videoReady=!0};var e=setInterval(function(){videoReady&&cameraReady&&(clearInterval(e),allReady())},100);$(".show_lyrics").on("click",function(){$(".lyrics").slideToggle()})}function postVideo(){var e=new FormData;e.append("filename","singer_"+(new Date).getTime()+".webm"),e.append("blob",blob),e.append("message",document.getElementById("post_message").value),$(".overlay_playback").addClass("sending");var a=new XMLHttpRequest;a.onreadystatechange=function(){4==a.readyState&&200==a.status&&"Successfully_uploaded"===a.responseText&&setTimeout(function(){$(".overlay_playback").removeClass("sending"),$("body").removeClass("playbacking").addClass("sent_completed")},1e3)},a.open("POST","upload.php"),a.send(e)}function allReady(){getAudioContext()}function createAnalyser(){var e=audioContext.createAnalyser();e.fftSize=128;var a=new Float32Array(e.frequencyBinCount),o=new Uint8Array(e.frequencyBinCount);audioContext.createMediaStreamSource(cameraStream).connect(e);var t=document.querySelector(".singer_analyser");!function n(){e.getFloatTimeDomainData(a),e.getByteFrequencyData(o),t.style.transform="scale("+(o[10]/512+1)+")";var r=requestAnimationFrame(n)}()}function cameraSuccess(e){cameraReady=!0,cameraStream=e,e.getAudioTracks().muted=!0,singer_video.volume=0,singer_video.src=URL.createObjectURL(e),createAnalyser()}function cameraError(){alert("Webカメラのエラーが起きました、パソコンにカメラがつながっているか確認してください")}function checkBrowser(){"undefined"==typeof AudioContext||"undefined"==typeof navigator.getUserMedia||"undefined"==typeof MediaRecorder?$("body").addClass("incompatible_brouser"):init()}var video=document.querySelector("#video"),singer_video=document.querySelector("#singer_video"),confirm_playBackVideo=document.querySelector("#confirm_playBackVideo"),ui_vocal_mute=document.querySelector("#ui_vo_mute"),ui_rec_start=document.querySelector("#ui_rec_start"),ui_rec_stop=document.querySelector("#ui_rec_stop"),ui_post_video=document.querySelector("#ui_post_video"),ui_overlay_close=document.querySelector(".post_container .cancel"),audioContext,gain,cameraReady=!1,videoReady=!1,recorder,cameraStream,recordTime=0,recordFlg=!1,blob;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var chunks=[];window.onload=function(){checkBrowser()};