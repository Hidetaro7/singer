function getAudioContext(){var e=audioContext.createMediaElementSource(video);gain=audioContext.createGain();var a=audioContext.createChannelSplitter(2),o=audioContext.createChannelMerger(2);e.connect(a),gain.gain.value=1,gain.value=1,a.connect(gain,1),gain.connect(o,0,0),gain.connect(o,0,1),a.connect(o,0,0),a.connect(o,0,1),o.connect(audioContext.destination)}function changeVocalMute(){this.checked&&gain?gain.gain.value=gain.value=0:gain.gain.value=gain.value=1}function rec_start(){ui_play_only.disabled=ui_rec_start.disabled=!0,recorder=new MediaRecorder(cameraStream),recorder.ondataavailable=function(e){console.log("data available, start playback");var a=new Blob([e.data],{type:e.data.type});confirm_playBackVideo.src=window.URL.createObjectURL(a)},video.play(),video.onended=rec_stop,video.onpause=rec_stop,recorder.start(),$("body").addClass("recording")}function rec_stop(){ui_play_only.disabled=ui_rec_start.disabled=!1,recorder&&recorder.stop(),video.pause(),video.currentTime=0,$("body").removeClass("recording playing").addClass("playbacking")}function init(){navigator.getUserMedia({video:!0,audio:!0},cameraSuccess,cameraError),ui_vocal_mute.onchange=changeVocalMute,ui_play_only.onclick=function(){this.disabled=!0,video.play(),$("body").addClass("playing")},ui_pause_only.onclick=function(){video.pause(),video.currentTime=0,ui_play_only.disabled=!1,$("body").removeClass("playing")},ui_rec_stop.onclick=rec_stop,ui_rec_start.onclick=rec_start,ui_overlay_close.onclick=function(){$("body").removeClass("playbacking")},video.oncanplay=function(){videoReady=!0};var e=setInterval(function(){videoReady&&cameraReady&&(clearInterval(e),allReady())},100)}function allReady(){getAudioContext()}function createAnalyser(){var e=audioContext.createAnalyser();e.fftSize=128;var a=new Float32Array(e.frequencyBinCount),o=new Uint8Array(e.frequencyBinCount);audioContext.createMediaStreamSource(cameraStream).connect(e);var n=document.querySelector(".singer_analyser");!function t(){e.getFloatTimeDomainData(a),e.getByteFrequencyData(o),n.style.transform="scale("+(o[10]/256+1)+")";var r=requestAnimationFrame(t)}()}function cameraSuccess(e){cameraReady=!0,cameraStream=e,e.getAudioTracks().muted=!0,singer_video.volume=0,singer_video.src=URL.createObjectURL(e),createAnalyser()}function cameraError(){alert("Webカメラのエラーが起きました、パソコンにカメラがつながっているか確認してください")}var video=document.querySelector("#video"),singer_video=document.querySelector("#singer_video"),confirm_playBackVideo=document.querySelector("#confirm_playBackVideo"),ui_vocal_mute=document.querySelector("#ui_vocal_mute"),ui_play_only=document.querySelector("#ui_play_only"),ui_pause_only=document.querySelector("#ui_pause_only"),ui_rec_start=document.querySelector("#ui_rec_start"),ui_rec_stop=document.querySelector("#ui_rec_stop"),ui_overlay_close=document.querySelector(".post_container .cancel"),audioContext=new AudioContext,gain,cameraReady=!1,videoReady=!1,recorder,cameraStream;window.onload=init;